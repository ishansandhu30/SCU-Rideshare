<!DOCTYPE html>
<html lang="en">
<head>
	<title>Driver Sign Up</title>

	<!-- Water CSS Light Theme -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css">
	<link rel="stylesheet" href="../CSS/CheckBox.css">
	<link rel="stylesheet" href="../CSS/RadioButton.css">
	<link rel="stylesheet" href="../CSS/Signup.css">



	<style>

		/* move to separate CSS file ??? also for passenger */
        body {
            -webkit-user-drag: none;
            -webkit-user-select: none;
        }

        [type="submit"] {
            background-color:#2196F3;
            color: White;
            font-weight: bolder;
            margin-top: 50px;
            margin-bottom: 50px;
            transform: scale(1.5);
            transition-duration: 0.5s;
        }
        [type="submit"]:hover {
	        transform: scale(2);
	        transition-duration: 0.5s;
            background-color:#2196F3;
            color: White;
        }
        [type="submit"]:active {
	        transform: translateY(50%);
        }



    body {
	    display: flex;
	    flex-direction: column;
	    align-items: center;
	    min-height: 100vh;
    }

    h1 {
      text-align: center;
    }

    form {
      width: 90%;
      max-width: 800px;
      margin: 0 auto;
    }

    form label,
    form input,
    form select {
      display: block;
      width: 100%;
      margin-bottom: 10px;
    }

    form button {
      display: block;
      margin: 0 auto;
    }

    .radio-group input[type="radio"],
    .selector-group select {
      margin-right: 10px;
    }

    .autocomplete-container {
      position: relative;
    }

    #suggestionsList {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: #202b38;
      border: 1px solid #3c4858;
      border-top: none;
      list-style-type: none;
      padding: 0;
      margin: 0;
      z-index: 1;
    }

    #suggestionsList li {
      padding: 10px;
      cursor: pointer;
      color: #fff;
    }

    #suggestionsList li:hover {
      background-color: #3c4858;
    }
	</style>

</head>



<body>
<h1>Driver Sign Up</h1>
<form id="driverSignupForm">

	<br>

	<label for="name">Name:</label>
	<input type="text" id="name" required>

	<br>

	<div class="usernameItem">
    <label for="username">Username:</label>
    <input type="text" id="username" placeholder="" required>
    <span class="error-message"></span>
	</div>

	<br>

	<div class="passwordItem">
    <label for="password">Password:</label>
    <input type="password" id="password" placeholder="Enter 8 or more characters" minlength="8" required>
    <span class="error-message"></span>
	</div>

	<div class="confirmPasswordItem">
    <label for="confirmPassword">Confirm Password:</label>
    <input type="password" id="confirmPassword" placeholder="" minlength="8" required>
    <span class="error-message"></span>
	</div>

	<br>

	<label for="major">Major:</label>
	<input type="text" id="major" placeholder="Enter the official SCU abbreviation" required>

	<br>

	<div class="phoneNumberItem">
		<label for="phoneNumber">Phone Number:</label>
		<input type="text" id="phoneNumber" placeholder="Enter phone number (e.g., 123-456-7890)" pattern="^\d{3}-\d{3}-\d{4}$" required>
		<span class="error-message"></span>
	</div>

	<br>

	<div class="autocomplete-container">
    <label for="homeLocation">Home Address:</label>
    <input type="text" id="homeLocation" placeholder="Autocomplete" required>
    <ul id="suggestionsList"></ul>
	</div>

	<br>
	<br>

	<h2>Schedule:</h2>
	<h4> Note that the final matched time may have up to half an hour difference. </h4>

	<br>

	<div id="scheduleContainer">
    <div class="scheduleItem">
      <label for="scheduleMonday"> Monday: </label>
      <input type="text" id="scheduleMonday" placeholder="Enter pickup time (e.g., 09:00 AM)" pattern="^(0[0-9]|1[0-2]):[0-5][0-9] (AM|PM)$" required>
      <span class="error-message"></span>

	    <br>

	    <label for="scheduleTuesday">Tuesday:</label>
      <input type="text" id="scheduleTuesday" placeholder="Enter pickup time (e.g., 09:00 AM)" pattern="^(0[0-9]|1[0-2]):[0-5][0-9] (AM|PM)$" required>
      <span class="error-message"></span>

	    <br>

      <label for="scheduleWednesday">Wednesday:</label>
      <input type="text" id="scheduleWednesday" placeholder="Enter pickup time (e.g., 09:00 AM)" pattern="^(0[0-9]|1[0-2]):[0-5][0-9] (AM|PM)$" required>
      <span class="error-message"></span>

	    <br>

      <label for="scheduleThursday">Thursday:</label>
      <input type="text" id="scheduleThursday" placeholder="Enter pickup time (e.g., 09:00 AM)" pattern="^(0[0-9]|1[0-2]):[0-5][0-9] (AM|PM)$" required>
      <span class="error-message"></span>

	    <br>

      <label for="scheduleFriday">Friday:</label>
      <input type="text" id="scheduleFriday" placeholder="Enter pickup time (e.g., 09:00 AM)" pattern="^(0[0-9]|1[0-2]):[0-5][0-9] (AM|PM)$" required>
      <span class="error-message"></span>

	</div>

	<br>



	<h2>Music Preferences:</h2>

	<br>

	<label class="custom_checkbox"> Classical
		<input type="checkbox">
		<span class="checkmark"></span>
	</label>
	<label class="custom_checkbox"> Jazz
		<input type="checkbox">
		<span class="checkmark"></span>
	</label>
	<label class="custom_checkbox"> R & B
		<input type="checkbox">
		<span class="checkmark"></span>
	</label>
	<label class="custom_checkbox"> Rock
		<input type="checkbox">
		<span class="checkmark"></span>
	</label>
	<label class="custom_checkbox"> Hip Hop
		<input type="checkbox">
		<span class="checkmark"></span>
	</label>
	<label class="custom_checkbox"> EDM
		<input type="checkbox">
		<span class="checkmark"></span>
	</label>

	<br>

	<h2> Gender: </h2>

	<br>

	<label class="custom_radiobutton"> Male
		<input type="radio" name="r" id="male">
		<span class="checkmark"></span>
	</label>
	<label class="custom_radiobutton"> Female
		<input type="radio" name="r" id="female">
		<span class="checkmark"></span>
	</label>
	<label class="custom_radiobutton"> Others
		<input type="radio" name="r" id="other">
		<span class="checkmark"></span>
	</label>


		<button id="signup" type="submit">Sign Up</button>

	</div>
</form>

<script>
    // OpenStreetMap Nominatim API URL
    const nominatimUrl = 'https://nominatim.openstreetmap.org/search?format=json&q=';

    function debounce(func, delay) {
        let timeoutId;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function validateTime(timeInput) {
        const timeRegex = /^(0[0-9]|1[0-2]):[0-5][0-9] (AM|PM)$/;
        return timeRegex.test(timeInput);
    }
    function validatePhoneNumber(phoneNumber) {
        const phoneRegex = /^\d{3}-\d{3}-\d{4}$/;
        return phoneRegex.test(phoneNumber);
    }


    function handleAddressInput() {
        const addressInput = document.getElementById('homeLocation');
        const suggestionsList = document.getElementById('suggestionsList');

        const address = addressInput.value;

        if (address.length >= 3) {
            fetchAddressSuggestions(address)
                .then(suggestions => {
                    suggestionsList.innerHTML = '';

                    suggestions.forEach(suggestion => {
                        const suggestionItem = document.createElement('li');
                        suggestionItem.textContent = suggestion;
                        suggestionItem.addEventListener('click', function() {
                            addressInput.value = suggestion;
                            suggestionsList.innerHTML = '';
                        });
                        suggestionsList.appendChild(suggestionItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching address suggestions:', error);
                });
        } else {
            suggestionsList.innerHTML = '';
        }
    }

    function fetchCoordinates(address) {
        return fetch(nominatimUrl + encodeURIComponent(address))
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const { lat, lon } = data[0];
                    return { latitude: parseFloat(lat), longitude: parseFloat(lon) };
                }
                return null;
            });
    }
    function validatePasswordMatch(password, confirmPassword) {
        return password === confirmPassword;
    }
    // Function to fetch address suggestions from the Nominatim API
    function fetchAddressSuggestions(address) {
        return fetch(nominatimUrl + encodeURIComponent(address))
            .then(response => response.json())
            .then(data => {
                return data.map(item => item.display_name);
            });
    }

    // Function to handle form submission
    function handleSubmit(event) {
        event.preventDefault();

        const usernameInput = document.getElementById('username');
        const username = usernameInput.value.trim();
        const usernameErrorMessage = usernameInput.nextElementSibling;

        if (username === '') {
            usernameErrorMessage.textContent = 'Please enter a username';
            return;
        } else {
            usernameErrorMessage.textContent = '';
        }

        const passwordInput = document.getElementById('password');
        const password = passwordInput.value;
        const passwordErrorMessage = passwordInput.nextElementSibling;

        if (password === '') {
            passwordErrorMessage.textContent = 'Please enter a password';
            return;
        } else {
            passwordErrorMessage.textContent = '';
        }

        const confirmPasswordInput = document.getElementById('confirmPassword');
        const confirmPassword = confirmPasswordInput.value;
        const confirmPasswordErrorMessage = confirmPasswordInput.nextElementSibling;

        if (confirmPassword === '') {
            confirmPasswordErrorMessage.textContent = 'Please confirm your password';
            return;
        } else if (!validatePasswordMatch(password, confirmPassword)) {
            confirmPasswordErrorMessage.textContent = 'Passwords do not match';
            confirmPasswordErrorMessage.style.color = 'red';
            confirmPasswordErrorMessage.style.fontWeight = 'bold';
            return;
        } else {
            confirmPasswordErrorMessage.textContent = '';
        }

        const scheduleInputs = document.querySelectorAll('#scheduleContainer input[type="text"]');
        let isValid = true;

        scheduleInputs.forEach(input => {
            const timeValue = input.value.trim();
            const errorMessage = input.nextElementSibling;

            if (timeValue === '' || !validateTime(timeValue)) {
                errorMessage.textContent = 'Please enter a valid time (e.g., 09:00 AM)';
                isValid = false;
            } else {
                errorMessage.textContent = '';
            }
        });

        if (!isValid) {
            return;
        }
        // Get form data
        const name = document.getElementById('name').value;
        const major = document.getElementById('major').value;
        const homeLocation = document.getElementById('homeLocation').value;
        const schedule = {
            monday: document.getElementById('scheduleMonday').value,
            tuesday: document.getElementById('scheduleTuesday').value,
            wednesday: document.getElementById('scheduleWednesday').value,
            thursday: document.getElementById('scheduleThursday').value,
            friday: document.getElementById('scheduleFriday').value
        };
        const musicTastes = Array.from(document.querySelectorAll('input[name="music"]:checked')).map(checkbox => checkbox.value);

        //const gender = document.getElementById('gender').value;
        if(document.getElementById('male') != null)     gender = "Male";
        if(document.getElementById('female') != null)     gender = "Female";
        if(document.getElementById('other') != null)     gender = "Other";
        //const genderPreference = document.querySelector('input[name="genderPreference"]:checked').value;

        const phoneNumberInput = document.getElementById('phoneNumber');
        const phoneNumber = phoneNumberInput.value.trim();
        const phoneNumberErrorMessage = phoneNumberInput.nextElementSibling;

        if (phoneNumber === '' || !validatePhoneNumber(phoneNumber)) {
            phoneNumberErrorMessage.textContent = 'Please enter a valid phone number (e.g., 123-456-7890)';
            return;
        } else {
            phoneNumberErrorMessage.textContent = '';
        }
        fetchCoordinates(homeLocation)
            .then(coordinates => {
                if (coordinates) {
                    const { latitude, longitude } = coordinates;

                    // Create JSON object
                    const driverData = {
                        name: name,
                        username: username,
                        password: password,
                        major: major,
                        homeLocation: homeLocation,
                        homeCoordinates: {
                            latitude: latitude,
                            longitude: longitude
                        },
                        schedule: schedule,
                        musicTastes: musicTastes,
                        gender: gender,
                        //genderPreference: genderPreference,
                        phoneNumber: phoneNumber
                    };

                    // Send data to server
                    fetch('http://localhost:3000/api/driver-signup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(driverData)
                    })
                        .then(response => {
                            if (response.ok) {
                                // Redirect to driver login page
                                window.location.href = 'driver-login.html';
                            } else {
                                // Handle error
                                console.error('Error signing up as a driver');
                            }
                        });
                } else {
                    console.error('Failed to fetch coordinates for the home location');
                }
            })
            .catch(error => {
                console.error('Error fetching coordinates:', error);
            });
    }

    // Add event listener to the form submission
    document.getElementById('signup').addEventListener('click', handleSubmit);
    document.getElementById('homeLocation').addEventListener('input', debounce(handleAddressInput, 500));
</script>

</body>
</html>